name: 文件夹管理

on:
  push:
    branches:
      - main
    paths:
      - '文件夹创建命令.txt'

jobs:
  manage-folders:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 执行文件夹管理命令
        run: |
          CHANGES_MADE=false
          
          # 逐行读取命令文件
          while IFS= read -r line || [[ -n "$line" ]]; do
            # 去除首尾空格
            line=$(echo "$line" | xargs)
            
            # 跳过空行和注释
            if [ -z "$line" ] || [[ "$line" =~ ^# ]]; then
              continue
            fi
            
            # 解析创建命令: 创建:文件夹名
            if [[ "$line" =~ ^创建:(.+)$ ]]; then
              FOLDER_NAME="${BASH_REMATCH[1]}"
              echo "【创建】$FOLDER_NAME"
              
              mkdir -p "$FOLDER_NAME"
              touch "$FOLDER_NAME/.gitkeep"
              CHANGES_MADE=true
              
            # 解析删除命令: 删除:文件夹名
            elif [[ "$line" =~ ^删除:(.+)$ ]]; then
              FOLDER_NAME="${BASH_REMATCH[1]}"
              echo "【删除】$FOLDER_NAME"
              
              if [ -d "$FOLDER_NAME" ]; then
                rm -rf "$FOLDER_NAME"
                CHANGES_MADE=true
                echo "  └─ 已删除"
              else
                echo "  └─ 文件夹不存在，跳过"
              fi
              
            else
              echo "⚠️ 无法识别的命令: '$line'"
              echo "  支持的格式: 创建:文件夹名 或 删除:文件夹名"
            fi
          done < "文件夹创建命令.txt"
          
          # 保存状态
          echo "changes_made=$CHANGES_MADE" >> $GITHUB_ENV
      
      - name: 提交更改
        if: env.changes_made == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "执行文件夹管理命令"
          git push
          echo "✅ 所有更改已提交"